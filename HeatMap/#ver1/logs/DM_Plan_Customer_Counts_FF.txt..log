BTEQ 08.02.01.00 Sat Jan 21 14:34:09 2006
 
+---------+---------+---------+---------+---------+---------+---------+----
                   
.SET ERRORLEVEL UNKNOWN SEVERITY 16;
+---------+---------+---------+---------+---------+---------+---------+----

.SET ERROROUT STDOUT;
 *** Error messages now directed to STDOUT.
+---------+---------+---------+---------+---------+---------+---------+----

--.LOGON dwkb.kb.cz/e_mmraz;
.LOGON dwkbtest.kb.cz/e_mmraz

 *** Logon successfully completed.
 *** Transaction Semantics are BTET.
 *** Character Set Name is 'ASCII'.
 
 *** Total elapsed time was 4 seconds.
 
+---------+---------+---------+---------+---------+---------+---------+----

DATABASE d_dwkb;

 *** New default database accepted. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

.SET MAXERROR 1
+---------+---------+---------+---------+---------+---------+---------+----

.RUN FILE="DM_Plan_Customer_Counts_FF.txt"
+---------+---------+---------+---------+---------+---------+---------+----
/********1*********2*********3*********4*********5*********6*********/
-- Code: TDMPCCFF
-- Name: TDMPCCFF.txt
-- Utility: BTEQ
-- Mutation: m_performrep_ts
-- Type: Transformaèní
-- Description: Skript T-fáze plnící tabulku
--              DM_Plan_Customer_Counts_FF v datamartu m_performrep_ts
-- Run when: Plnìní martu m_performrep_ts.
--           Spouští se v procese ultimove transformace.
-- User: load_performrep
-- Repeatable: Pokud nebyl dokonèen, lze opakovat.
-- Documentation: m_performrep_ts.pdm
-- Date used: 200X-XX-XX
/********************************************************************/
-- V_MD_DWE_Date: ano
/********************************************************************/
--  MMR * 2005-12-20 FIRST WRITTEN
-- Changes:
/********************************************************************/

--.RUN FILE='i:\IFSec\InformaticaServer\CtlFiles\logon_performrep.txt'

.SET MAXERROR 1
+---------+---------+---------+---------+---------+---------+---------+----

DATABASE m_performrep_ts;

 *** New default database accepted. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

.SET ERRORLEVEL UNKNOWN SEVERITY 16;
+---------+---------+---------+---------+---------+---------+---------+----
.SET ERROROUT STDOUT;
 *** Error messages now directed to STDOUT.
+---------+---------+---------+---------+---------+---------+---------+----
.SET ERRORLEVEL 3807 SEVERITY 0;
+---------+---------+---------+---------+---------+---------+---------+----

/* probably drop of tmp tables */

drop table tmp_DM_Customer_IN_Counts;
 *** Failure 3807 Object 'tmp_DM_Customer_IN_Counts' does not exist.
                Statement# 1, Info =0 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
drop table Tmp_BoY_Dates;
 *** Failure 3807 Object 'Tmp_BoY_Dates' does not exist.
                Statement# 1, Info =0 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
drop table tmp_DM_Plan_Customer_Counts_FF;
 *** Failure 3807 Object 'tmp_DM_Plan_Customer_Counts_FF' does not exist.
                Statement# 1, Info =0 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----


.SET ERRORLEVEL 3807 SEVERITY 8;
+---------+---------+---------+---------+---------+---------+---------+----

/*************** MD_SCRIPT_TIMES.SCRIPT_START ***********************/

--EXEC dwkb_meta.MD_Script_Times_Ins(Script_Code = 'TDMPCCFF');


/****START***** create tmp tables *****/

--Tabulka obsahuje datum posledniho dne minuleho roku
CREATE VOLATILE TABLE Tmp_BoY_Dates
(
   BoY DATE FORMAT 'YYYY-MM-DD'
)
ON COMMIT PRESERVE ROWS;

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----


--mnozstvi spravovanych klientu v portfoliu aktualni jednotce
create SET table tmp_DM_Customer_IN_Counts 
(
    Date_Valid                      DATE FORMAT 'YYYY-MM-DD'    not null 
    ,Service_Segment                CHAR(3)  not null
    ,Org_Unit_Type                  CHAR(3)  not null                     
 
    ,Org_Unit_Code                  CHAR(5)  not null                   
    ,Org_Unit_Code_Suppl            CHAR(3)  not null
    ,Org_Unit_Level                 CHAR(1)  not null                     
 
    ,Officer_Id                     CHAR(3)   
    ,Client_Count_In                INTEGER  not null
    ,Client_Count_Out               INTEGER  not null 
)
UNIQUE PRIMARY INDEX tmp_DM_Customer_IN_Counts_UPI (Date_Valid
                                            ,Service_Segment
                                            ,Org_Unit_Type
                                            ,Org_Unit_Code
                                            ,Org_Unit_Code_Suppl
                                            ,Org_Unit_Level 
                                            ,Officer_Id);

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

COLLECT STATISTICS tmp_DM_Customer_IN_Counts index tmp_DM_Customer_IN_Count
s_UPI ;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----


--tabulka obsahuje data pred vlozenim do hlavni tabulky
create SET table tmp_DM_Plan_Customer_Counts_FF 
(
    Date_Valid                     DATE                 not null,
    Node_Code                      CHAR(17)             not null,
    Service_Segment_Code           CHAR(3)              not null,
    MFF_Client_Saldo               DECIMAL(17,2)                ,
    YFF_Client_Saldo               DECIMAL(17,2)                
)
unique primary index DM_Plan_Cust_Counts_FF_UPI ( Date_Valid, Node_Code, S
ervice_Segment_Code );

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

collect statistics on tmp_DM_Plan_Customer_Counts_FF index DM_Plan_Cust_Cou
nts_FF_UPI;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

/****END***** create tmp tables *****/

--INSERT GLOBAL TABLES FOR NET AND GROSS SALES

INSERT INTO Tmp_BoY_Dates
(
  BoY
)
SELECT CAST(
            (EXTRACT(YEAR FROM dwkb_meta.V_MD_DWE_Date.DWE_Date))||'-01-31
'
              AS DATE FORMAT 'YYYY-MM-DD'
                )
;

 *** Insert completed. One row added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

----------------------------------------------------------------------------------------------
--pocet zakazniku obsluhujucich aktualni jednotkou aktualni mesic
INSERT INTO tmp_DM_Customer_IN_Counts
(
    Date_Valid          
    ,Service_Segment     
    ,Org_Unit_Type      
    ,Org_Unit_Code      
    ,Org_Unit_Code_Suppl
    ,Org_Unit_Level
    ,Officer_Id       
    ,Client_Count_In
    ,Client_Count_Out       
)
SELECT
    A.Date_Valid
    ,CASE
      WHEN B.Management_Type = 'MC'
        THEN 'MEM'
      WHEN SUBSTR(A.Segment_Code_12,1,1) = 'B' AND B.Management_Type = 'XX
'
        THEN 'SB'
      WHEN SUBSTR(A.Segment_Code_12,1,1) = 'P' AND B.Management_Type = 'XX
'
        THEN 'IND'
    END Service_Segment   
    ,B.Org_Unit_Type_6      
    ,B.Org_Unit_Code_6      
    ,B.Org_Unit_Code_Suppl_6
    ,'8'
    ,SUBSTR(A.Officer_Code,7,3) AS Officer_Ide
    ,SUM(Client_Count_In)
    ,SUM(Client_Count_Out)
FROM V_DM_Cust_Childless_Counts A
LEFT OUTER JOIN dwkb.R_Unit_Renumber G
ON SUBSTR(A.Officer_Code,1,6) = G.Original_Unit_Code
AND A.Date_Valid BETWEEN G.Start_Date AND G.End_Date
INNER JOIN V_D_Org_Business B
ON COALESCE(G.Unit_Code || SUBSTR(A.Officer_Code,7,3),A.Officer_Code) = B.
Officer_Code
GROUP BY A.Date_Valid, Service_Segment, B.Org_Unit_Type_6, B.Org_Unit_Code
_6, B.Org_Unit_Code_Suppl_6, Officer_Ide
WHERE A.Date_Valid BETWEEN Tmp_BoY_Dates.BoY AND dwkb_meta.V_MD_DWE_Date.D
WE_Date
AND B.Management_Type IN ('XX', 'MC') AND A.Segment_Code_12 <> 'XX'

;

 *** Insert completed. 4677 rows added. 
 *** Total elapsed time was 29 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

COLLECT STATISTICS tmp_DM_Customer_IN_Counts
;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

-------------------------
--pocet zakazniku obsluhujucich aktualni jednotkou aktualni mesic
INSERT INTO tmp_DM_Customer_IN_Counts
(
    Date_Valid          
    ,Service_Segment     
    ,Org_Unit_Type      
    ,Org_Unit_Code      
    ,Org_Unit_Code_Suppl
    ,Org_Unit_Level
    ,Officer_Id       
    ,Client_Count_In
    ,Client_Count_Out       
)
SELECT
    A.Date_Valid
    ,CASE
      WHEN B.Management_Type = 'MC'
        THEN 'MEM'
      WHEN SUBSTR(A.Segment_Code_12,1,1) = 'B' AND B.Management_Type = 'XX
'
        THEN 'SB'
      WHEN SUBSTR(A.Segment_Code_12,1,1) = 'P' AND B.Management_Type = 'XX
'
        THEN 'IND'
    END Service_Segment   
    ,B.Org_Unit_Type_6      
    ,B.Org_Unit_Code_6      
    ,B.Org_Unit_Code_Suppl_6
    ,'6'
    ,NULL
    ,SUM(Client_Count_In)
    ,SUM(Client_Count_Out)
FROM V_DM_Cust_Childless_Counts A
LEFT OUTER JOIN dwkb.R_Unit_Renumber G
ON SUBSTR(A.Officer_Code,1,6) = G.Original_Unit_Code
AND A.Date_Valid BETWEEN G.Start_Date AND G.End_Date
INNER JOIN V_D_Org_Business B
ON COALESCE(G.Unit_Code || SUBSTR(A.Officer_Code,7,3),A.Officer_Code) = B.
Officer_Code
GROUP BY A.Date_Valid, Service_Segment, B.Org_Unit_Type_6, B.Org_Unit_Code
_6, B.Org_Unit_Code_Suppl_6
WHERE A.Date_Valid BETWEEN Tmp_BoY_Dates.BoY AND dwkb_meta.V_MD_DWE_Date.D
WE_Date
AND B.Management_Type IN ('XX', 'MC') AND A.Segment_Code_12 <> 'XX' 

;

 *** Insert completed. 756 rows added. 
 *** Total elapsed time was 29 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

COLLECT STATISTICS tmp_DM_Customer_IN_Counts
;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

-------------------------
--pocet zakazniku obsluhujucich aktualni jednotkou aktualni mesic
INSERT INTO tmp_DM_Customer_IN_Counts
(
    Date_Valid          
    ,Service_Segment     
    ,Org_Unit_Type      
    ,Org_Unit_Code      
    ,Org_Unit_Code_Suppl
    ,Org_Unit_Level
    ,Officer_Id       
    ,Client_Count_In
    ,Client_Count_Out       
)
SELECT
    A.Date_Valid
    ,CASE
      WHEN B.Management_Type = 'MC'
        THEN 'MEM'
      WHEN SUBSTR(A.Segment_Code_12,1,1) = 'B' AND B.Management_Type = 'XX
'
        THEN 'SB'
      WHEN SUBSTR(A.Segment_Code_12,1,1) = 'P' AND B.Management_Type = 'XX
'
        THEN 'IND'
    END Service_Segment   
    ,B.Org_Unit_Type_4      
    ,B.Org_Unit_Code_4      
    ,B.Org_Unit_Code_Suppl_4
    ,'4'
    ,NULL
    ,SUM(Client_Count_In)
    ,SUM(Client_Count_Out)
FROM V_DM_Cust_Childless_Counts A
LEFT OUTER JOIN dwkb.R_Unit_Renumber G
ON SUBSTR(A.Officer_Code,1,6) = G.Original_Unit_Code
AND A.Date_Valid BETWEEN G.Start_Date AND G.End_Date
INNER JOIN V_D_Org_Business B
ON COALESCE(G.Unit_Code || SUBSTR(A.Officer_Code,7,3),A.Officer_Code) = B.
Officer_Code
GROUP BY A.Date_Valid, Service_Segment, B.Org_Unit_Type_4, B.Org_Unit_Code
_4, B.Org_Unit_Code_Suppl_4
WHERE A.Date_Valid BETWEEN Tmp_BoY_Dates.BoY AND dwkb_meta.V_MD_DWE_Date.D
WE_Date
AND B.Management_Type IN ('XX', 'MC') AND A.Segment_Code_12 <> 'XX'

;

 *** Insert completed. 117 rows added. 
 *** Total elapsed time was 30 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

COLLECT STATISTICS tmp_DM_Customer_IN_Counts
;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

-------------------------
--pocet zakazniku obsluhujucich aktualni jednotkou aktualni mesic
INSERT INTO tmp_DM_Customer_IN_Counts
(
    Date_Valid          
    ,Service_Segment     
    ,Org_Unit_Type      
    ,Org_Unit_Code      
    ,Org_Unit_Code_Suppl
    ,Org_Unit_Level
    ,Officer_Id       
    ,Client_Count_In
    ,Client_Count_Out       
)
SELECT
    A.Date_Valid
    ,CASE
      WHEN B.Management_Type = 'MC'
        THEN 'MEM'
      WHEN SUBSTR(A.Segment_Code_12,1,1) = 'B' AND B.Management_Type = 'XX
'
        THEN 'SB'
      WHEN SUBSTR(A.Segment_Code_12,1,1) = 'P' AND B.Management_Type = 'XX
'
        THEN 'IND'
    END Service_Segment   
    ,B.Org_Unit_Type_3      
    ,B.Org_Unit_Code_3      
    ,B.Org_Unit_Code_Suppl_3
    ,'3'
    ,NULL
    ,SUM(Client_Count_In)
    ,SUM(Client_Count_Out)
FROM V_DM_Cust_Childless_Counts A
LEFT OUTER JOIN dwkb.R_Unit_Renumber G
ON SUBSTR(A.Officer_Code,1,6) = G.Original_Unit_Code
AND A.Date_Valid BETWEEN G.Start_Date AND G.End_Date
INNER JOIN V_D_Org_Business B
ON COALESCE(G.Unit_Code || SUBSTR(A.Officer_Code,7,3),A.Officer_Code) = B.
Officer_Code
GROUP BY A.Date_Valid, Service_Segment, B.Org_Unit_Type_3, B.Org_Unit_Code
_3, B.Org_Unit_Code_Suppl_3
WHERE A.Date_Valid BETWEEN Tmp_BoY_Dates.BoY AND dwkb_meta.V_MD_DWE_Date.D
WE_Date
AND B.Management_Type IN ('XX', 'MC')  AND A.Segment_Code_12 <> 'XX' 

;

 *** Insert completed. 18 rows added. 
 *** Total elapsed time was 29 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

COLLECT STATISTICS tmp_DM_Customer_IN_Counts
;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
-------------------------
--pocet zakazniku obsluhujucich aktualni jednotkou aktualni mesic
INSERT INTO tmp_DM_Customer_IN_Counts
(
    Date_Valid          
    ,Service_Segment     
    ,Org_Unit_Type      
    ,Org_Unit_Code      
    ,Org_Unit_Code_Suppl
    ,Org_Unit_Level
    ,Officer_Id       
    ,Client_Count_In
    ,Client_Count_Out       
)
SELECT
    A.Date_Valid
    ,CASE
      WHEN B.Management_Type = 'MC'
        THEN 'MEM'
      WHEN SUBSTR(A.Segment_Code_12,1,1) = 'B' AND B.Management_Type = 'XX
'
        THEN 'SB'
      WHEN SUBSTR(A.Segment_Code_12,1,1) = 'P' AND B.Management_Type = 'XX
'
        THEN 'IND'
    END Service_Segment   
    ,B.Org_Unit_Type_2      
    ,B.Org_Unit_Code_2      
    ,B.Org_Unit_Code_Suppl_2
    ,'2'
    ,NULL
    ,SUM(Client_Count_In)
    ,SUM(Client_Count_Out)
FROM V_DM_Cust_Childless_Counts A
LEFT OUTER JOIN dwkb.R_Unit_Renumber G
ON SUBSTR(A.Officer_Code,1,6) = G.Original_Unit_Code
AND A.Date_Valid BETWEEN G.Start_Date AND G.End_Date
INNER JOIN V_D_Org_Business B
ON COALESCE(G.Unit_Code || SUBSTR(A.Officer_Code,7,3),A.Officer_Code) = B.
Officer_Code
GROUP BY A.Date_Valid, Service_Segment, B.Org_Unit_Type_2, B.Org_Unit_Code
_2, B.Org_Unit_Code_Suppl_2
WHERE A.Date_Valid BETWEEN Tmp_BoY_Dates.BoY AND dwkb_meta.V_MD_DWE_Date.D
WE_Date
AND B.Management_Type IN ('XX', 'MC')  AND A.Segment_Code_12 <> 'XX'

;

 *** Insert completed. 3 rows added. 
 *** Total elapsed time was 29 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

COLLECT STATISTICS tmp_DM_Customer_IN_Counts
;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

-- END

--INSERT 

INSERT INTO tmp_DM_Plan_Customer_Counts_FF
(
    Date_Valid          
    ,Node_Code           
    ,Service_Segment_Code
    ,MFF_Client_Saldo    
    ,YFF_Client_Saldo    
)
SELECT
  A.Date_Valid AS Date_Valid
  ,CASE
    WHEN A.Org_Unit_Level = '8' AND A.Service_Segment = 'MEM'
      THEN 'RMM'||A.Org_Unit_Type||A.Org_Unit_Code||A.Org_Unit_Code_Suppl|
|A.Officer_Id
    WHEN A.Org_Unit_Level = '8' AND (A.Service_Segment = 'IND' OR A.Servic
e_Segment = 'SB')
      THEN 'RMR'||A.Org_Unit_Type||A.Org_Unit_Code||A.Org_Unit_Code_Suppl|
|A.Officer_Id
    WHEN A.Org_Unit_Level = '6'
      THEN  'BRM'||A.Org_Unit_Type||A.Org_Unit_Code||A.Org_Unit_Code_Suppl
||'XXX'
    WHEN A.Org_Unit_Level = '4'
      THEN 'GBM'||A.Org_Unit_Type||A.Org_Unit_Code||A.Org_Unit_Code_Suppl|
|'XXX'
    WHEN A.Org_Unit_Level = '3'
      THEN 'RGM'||A.Org_Unit_Type||A.Org_Unit_Code||A.Org_Unit_Code_Suppl|
|'XXX'
    WHEN A.Org_Unit_Level = '2'
      THEN 'DSM'||A.Org_Unit_Type||A.Org_Unit_Code||A.Org_Unit_Code_Suppl|
|'XXX'
    END Node_Code
  ,A.Service_Segment AS Service_Segment_Code
  ,(CASE
       WHEN  (TTARGET.Client_Count_In_Plan <> TTARGET.Client_Count_Out_Pla
n)
        THEN CAST( 
            ((CAST((A.Client_Count_In - A.Client_Count_Out) AS FLOAT) 
            / (TTARGET.Client_Count_In_Plan - TTARGET.Client_Count_Out_Pla
n)) * 100) 
                AS DECIMAL(17,2) ) 
       ELSE NULL
     END) AS   MFF_Client_Saldo       
  ,(CASE
       WHEN  (YTD_TTARGET.Client_Count_In <> YTD_TTARGET.Client_Count_Out)

        THEN CAST( 
            ((CAST((YTD.Client_Count_In - YTD.Client_Count_Out) AS FLOAT) 

            / (YTD_TTARGET.Client_Count_In - YTD_TTARGET.Client_Count_Out)
) * 100) 
                AS DECIMAL(17,2) ) 
       ELSE NULL
     END) AS   YFF_Client_Saldo       

FROM tmp_DM_Customer_IN_Counts A

LEFT OUTER JOIN DM_Plan_Customer_Counts TTARGET
ON  A.Service_Segment       = TTARGET.Service_Segment_Code     
AND A.Org_Unit_Type         = TTARGET.Org_Unit_Type      
AND A.Org_Unit_Code         = TTARGET.Org_Unit_Code      
AND A.Org_Unit_Code_Suppl   = TTARGET.Org_Unit_Code_Suppl
AND A.Org_Unit_Level        = TTARGET.Org_Unit_Level
AND COALESCE(A.Officer_Id,'XXX')  = COALESCE(TTARGET.Officer_Id,'XXX')
AND A.Date_Valid            = TTARGET.Date_Valid


LEFT OUTER JOIN(
SELECT
    Service_Segment_Code
    ,Org_Unit_Type       
    ,Org_Unit_Code       
    ,Org_Unit_Code_Suppl 
    ,Org_Unit_Level      
    ,Officer_Id          
    ,SUM(Client_Count_In_Plan) Client_Count_In
    ,SUM(Client_Count_Out_Plan) Client_Count_Out
  FROM DM_Plan_Customer_Counts
  WHERE Date_Valid BETWEEN Tmp_BoY_Dates.BoY AND dwkb_meta.V_MD_DWE_Date.D
WE_Date
  GROUP BY 1,2,3,4,5,6
) YTD_TTARGET

ON  A.Service_Segment       = YTD_TTARGET.Service_Segment_Code     
AND A.Org_Unit_Type         = YTD_TTARGET.Org_Unit_Type      
AND A.Org_Unit_Code         = YTD_TTARGET.Org_Unit_Code      
AND A.Org_Unit_Code_Suppl   = YTD_TTARGET.Org_Unit_Code_Suppl
AND A.Org_Unit_Level        = YTD_TTARGET.Org_Unit_Level
AND COALESCE(A.Officer_Id,'XXX')  = COALESCE(YTD_TTARGET.Officer_Id,'XXX')


  
LEFT OUTER JOIN(
SELECT 
    Service_Segment     
    ,Org_Unit_Type      
    ,Org_Unit_Code      
    ,Org_Unit_Code_Suppl
    ,Org_Unit_Level
    ,Officer_Id       
    ,SUM(Client_Count_In) AS Client_Count_In
    ,SUM(Client_Count_Out) AS Client_Count_Out      
  FROM tmp_DM_Customer_IN_Counts
  WHERE Date_Valid >= Tmp_BoY_Dates.BoY
  GROUP BY 1,2,3,4,5,6
) YTD

ON  A.Service_Segment       = YTD.Service_Segment     
AND A.Org_Unit_Type         = YTD.Org_Unit_Type      
AND A.Org_Unit_Code         = YTD.Org_Unit_Code      
AND A.Org_Unit_Code_Suppl   = YTD.Org_Unit_Code_Suppl
AND A.Org_Unit_Level        = YTD.Org_Unit_Level
AND COALESCE(A.Officer_Id,'XXX')  = COALESCE(YTD.Officer_Id,'XXX')

WHERE A.Date_Valid = dwkb_meta.V_MD_DWE_Date.DWE_Date
;

 *** Insert completed. 5571 rows added. 
 *** Total elapsed time was 2 seconds.


+---------+---------+---------+---------+---------+---------+---------+----


COLLECT STATISTICS ON tmp_DM_Plan_Customer_Counts_FF;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO tmp_DM_Plan_Customer_Counts_FF
(
       Date_Valid          
      ,Node_Code                      
      ,Service_Segment_Code           
      ,MFF_Client_Saldo    
      ,YFF_Client_Saldo    
)
SELECT 
      Date_Valid                     
      ,CASE
        WHEN Service_Segment_Code = 'MEM' 
          THEN 'HOC'||SUBSTR(Node_Code,3)                      
        ELSE 'HOR'||SUBSTR(Node_Code,3)
       END Node_Code
      ,Service_Segment_Code           
    ,MFF_Client_Saldo    
    ,YFF_Client_Saldo    
FROM tmp_DM_Plan_Customer_Counts_FF
WHERE SUBSTR(Node_Code,1,3) = 'GBM'
;

 *** Insert completed. 117 rows added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----


COLLECT STATISTICS tmp_DM_Plan_Customer_Counts_FF;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----


/**************INSERT START INTO DM_NET_Sales_M***********************/
DELETE FROM DM_Plan_Customer_Counts_FF WHERE Date_Valid < ADD_MONTHS(Tmp_Bo
Y_Dates.BoY,-48) OR 
Date_VAlid = dwkb_meta.V_MD_DWE_Date.DWE_Date;

 *** Delete completed. 2011 rows removed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

COLLECT STATISTICS DM_Plan_Customer_Counts_FF;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----


INSERT INTO DM_Plan_Customer_Counts_FF
(
       Date_Valid          
      ,Node_Code                      
      ,Service_Segment_Code           
      ,MFF_Client_Saldo    
      ,YFF_Client_Saldo    
)
SELECT
       Date_Valid          
      ,Node_Code                      
      ,Service_Segment_Code           
      ,(CASE WHEN MFF_Client_Saldo  > 999 THEN 999 
        WHEN MFF_Client_Saldo  < -999 THEN -999 ELSE MFF_Client_Saldo END)
    
      ,(CASE WHEN YFF_Client_Saldo  > 999 THEN 999 
        WHEN YFF_Client_Saldo  < -999 THEN -999 ELSE YFF_Client_Saldo END)
    
FROM tmp_DM_Plan_Customer_Counts_FF 
;

 *** Insert completed. 5688 rows added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

COLLECT STATISTICS DM_Plan_Customer_Counts_FF;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----



--COLLECT STATISTICS Gross_Business_Sales_M;

drop table tmp_DM_Customer_IN_Counts;

 *** Table has been dropped. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
drop table Tmp_BoY_Dates;

 *** Table has been dropped. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
drop table tmp_DM_Plan_Customer_Counts_FF;

 *** Table has been dropped. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
--EXEC dwkb_meta.MD_Script_Times_Upd(Script_Code = 'TDMPCCFF');

.IF ERRORCODE > 0 THEN .QUIT 8;
+---------+---------+---------+---------+---------+---------+---------+----
                                                                                
 *** Warning: EOF on INPUT stream.
+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORCODE > 0 THEN .QUIT ERRORCODE;
+---------+---------+---------+---------+---------+---------+---------+----
                                                                    
.LOGOFF;
 *** You are now logged off from the DBC.
+---------+---------+---------+---------+---------+---------+---------+----

.QUIT ERRORCODE;
 *** Exiting BTEQ...
 *** RC (return code) = 0 
